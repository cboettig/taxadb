<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>taxald tutorial • taxald</title>
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="taxald tutorial">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">taxald</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/taxald.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/schema.html">Database schema for taxald</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>taxald tutorial</h1>
                        <h4 class="author">Carl Boettiger</h4>
            
            <h4 class="date">2018-10-10</h4>
      
      
      <div class="hidden name"><code>taxald.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(taxald)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(tidyr)</a></code></pre></div>
<div id="introduction-the-problem-of-name-matching" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction-the-problem-of-name-matching" class="anchor"></a>Introduction: the problem of name matching</h1>
<p>We frequently want to combine different data sources using species names. Perhaps we have one table which gives us occurrance information for a given list of species, and another table that contains trait information for species, and maybe a third source that provides a phylogenetic tree. If our system of scientific species names was perfect, we could simply do a “table join” using species name as the joining <code>key</code>, and all would be well.</p>
<p>Unfortunately, as anyone who has attempted this kind of exercise over more than a handful of species has discovered, this often works for most but very rarely for all of the species names involved. There are several reasons this process runs into problems.</p>
<p><strong>Synonyms</strong>. One of the most common problems is the existence of synonyms: different names or different spellings of a given scientific name. While this could include definite miss-spellings, for there are many species for which authorities can differ in the preferred name – essentially, two or more different names correspond to the same species, and should be treated as such in our species join.</p>
<p>For instance, we consider the 233 primate species names used in the <code>geiger</code> package <code>primates</code> data. To avoid installing that dependency-heavy package, a copy of these names has been cached in <code>taxald</code> and can be loaded as follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">ex &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"primates.tsv.bz2"</span>, <span class="dt">package =</span> <span class="st">"taxald"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">primates &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/readr/topics/read_delim">read_tsv</a></span>(ex)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">primates</a></code></pre></div>
<p>Our goal will be to associate each name with a definitive taxonomic ID of an existing naming authority. This will allow us to merge on IDs directly, rather than names. By mapping both recognized names and synonyms to the same corresponding taxonomic ID, we can be sure that we can join the relevant data correctly.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>To get started, we’ll install all the data sources available to <code>taxald</code> into a local database. This may take a while, particularly over a slow internet connection, but it needs to be done only once. The downloaded size of all data is around 3 GB. Once this task completes, our subsequent operations should all be quite fast.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/td_create.html">td_create</a></span>(<span class="dt">authorities =</span> <span class="st">"all"</span>)</a></code></pre></div>
</div>
<div id="resolving-names" class="section level2">
<h2 class="hasAnchor">
<a href="#resolving-names" class="anchor"></a>Resolving names</h2>
<p><strong>Developer note: the following outlines the current mechanism for name resolution, which queries the recognized names and synonyms (if present) of each authority sequentially. While this is illustrative of the underlying process, we probably want a helper function which automates this.</strong></p>
<p>Match a list of 233 species names against a naming authority:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">my_taxa &lt;-<span class="st"> </span>primates <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># 233 taxa</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">id =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species)) </a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">is.na</span>(my_taxa<span class="op">$</span>id) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>()</a></code></pre></div>
<p>Only 3 species are missing ids, so we have managed to resolve 230 of the 233 species. Not bad!</p>
<p>Note that in fact only 180 of the names were recognized as valid species names by ITIS initially. Another 50 were resolved through synonym matching, which we can see by turning off the synonym-matching behavior and requesting ids only for direct matches:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">tmp &lt;-<span class="st"> </span>primates <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">id =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, </a>
<a class="sourceLine" id="cb5-3" data-line-number="3">                  <span class="dt">synonyms_check =</span> <span class="ot">FALSE</span>)) </a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">is.na</span>(tmp<span class="op">$</span>id) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>()</a></code></pre></div>
<p>Similarly, we can compute ids for all authorities:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">my_taxa &lt;-<span class="st"> </span>primates <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">itis =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"itis"</span>),</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">         <span class="dt">ncbi =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"ncbi"</span>),</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">         <span class="dt">col =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"col"</span>),</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">         <span class="dt">gbif =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"gbif"</span>),</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">         <span class="dt">wd =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"wd"</span>),</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">         <span class="dt">tpl =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"tpl"</span>),</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">         <span class="dt">fb =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"fb"</span>),</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">         <span class="dt">slb =</span> <span class="kw"><a href="../reference/ids.html">ids</a></span>(species, <span class="st">"slb"</span>)) </a></code></pre></div>
<p>Can any single authority resolve all species names?</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">my_taxa <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>species) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="st">  </span>purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_dbl</a></span>(<span class="cf">function</span>(x) <span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(x)))</a></code></pre></div>
<p>No luck. Looks like <code>itis</code> has the most matches with 230. (Of course taxon-specific authorities like The Plant List, FishBase, and SeaLifeBase contain no primates).</p>
<p>We can also ask: do any species have no match in any authority?</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">has_match &lt;-<span class="st"> </span>my_taxa <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="st">  </span>purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_dfc</a></span>(<span class="cf">function</span>(x) <span class="op">!</span><span class="kw">is.na</span>(x)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="st">  </span><span class="kw">rowSums</span>() <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">my_taxa <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span>has_match)</a></code></pre></div>
<p>One species still fails to resolve under any authority. Somewhat surprising given that this Black-and-white lemur from Madagascar is common enough to have a <a href="https://en.wikipedia.org/wiki/Black-and-white_ruffed_lemur">Wikipedia page</a>.</p>
</div>
<div id="hierarchy" class="section level2">
<h2 class="hasAnchor">
<a href="#hierarchy" class="anchor"></a>Hierarchy</h2>
<p>Once we have resolved our ids, we can also get full classification information. This example uses the default authority, ITIS:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">primate_ids &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ids.html">ids</a></span>(primates<span class="op">$</span>species)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="../reference/classification.html">classification</a></span>(<span class="dt">id =</span> primate_ids)</a></code></pre></div>
<p>the <code>classification</code> function can work on species names directly, but this will not resolve syonyms to identifiers first. As a result, only the 180 already recognized species names can be resolved in this case:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/classification.html">classification</a></span>(<span class="dt">species =</span> primate_ids<span class="op">$</span>name)</a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#introduction-the-problem-of-name-matching">Introduction: the problem of name matching</a><ul class="nav nav-pills nav-stacked">
<li><a href="#setup">Setup</a></li>
      <li><a href="#resolving-names">Resolving names</a></li>
      <li><a href="#hierarchy">Hierarchy</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Carl Boettiger.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
